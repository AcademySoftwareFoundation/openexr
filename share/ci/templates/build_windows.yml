# azure-pipelines template file
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops

parameters:
  buildType: Release
steps:
- script: |
    @ECHO ON
    REM # Build Vars #
    SET CONFIGURATION=Release
    SET PLATFORM=x64
    REM # VC Vars #
    SET VCVAR="%programfiles(x86)%\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
    if exist %VCVAR% call %VCVAR% %PLATFORM%
    SET VCVAR="%programfiles(x86)%\Microsoft Visual Studio\2017\Professional\VC\Auxiliary\Build\vcvarsall.bat"
    if exist %VCVAR% call %VCVAR% %PLATFORM%
    SET VCVAR="%programfiles(x86)%\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat"
    if exist %VCVAR% call %VCVAR% %PLATFORM%
    @ECHO ON
    REM # MSBuild Vars #
    ECHO BUILD %CONFIGURATION% %PLATFORM%
    set _SCRIPT_DRIVE=%~d0
    set _SCRIPT_FOLDER=%~dp0
    set INITDIR=%_SCRIPT_FOLDER%
    set SRC=D:\a\1\s
    ECHO %SRC%
    set BUILDTREE=%SRC%\build-win\
    ECHO %BUILDTREE%
    SET cmake_platform="Visual Studio 15 2017 Win64"
    REM # create Build Tree #
    mkdir %BUILDTREE%
    mkdir %BUILDTREE%\deps
    REM # Change to Build Tree directory #
    cd %BUILDTREE%
    REM # packages from nuget #
    cd %BUILDTREE%\deps
    SET VERZLIB=1.2.11.8899
    set ZLIBDIR=%BUILDTREE%\deps\zlib-msvc-%PLATFORM%.%VERZLIB%\build\native
    nuget install zlib-msvc-%PLATFORM% -Version %VERZLIB%
    SET VERFLTK=1.3.4.8788
    set FLTKDIR=%BUILDTREE%\deps\FLTK-msvc-%PLATFORM%.%VERFLTK%\build\native
    nuget install FLTK-msvc-%PLATFORM% -Version %VERFLTK%
    mkdir %BUILDTREE%\OpenEXR
    cd %BUILDTREE%\OpenEXR
    REM # MSVC CMAKE OpenEXR #
    cmake -G %cmake_platform% ^
    -DBUILD_ILMBASE_STATIC:BOOL=ON ^
    -DOPENEXR_BUILD_ILMBASE:BOOL=ON ^
    -DOPENEXR_BUILD_OPENEXR:BOOL=ON ^
    -DOPENEXR_BUILD_PYTHON_LIBS:BOOL=OFF ^
    -DOPENEXR_BUILD_VIEWERS:BOOL=ON ^
    -DOPENEXR_BUILD_TESTS:BOOL=ON ^
    -DOPENEXR_RUN_FUZZ_TESTS:BOOL=OFF ^
    -DOPENEXR_BUILD_UTILS:BOOL=ON ^
    -DOPENEXR_BUILD_SHARED:BOOL=OFF ^
    -DOPENEXR_BUILD_STATIC:BOOL=ON ^
    -DBUILD_SHARED_LIBS:BOOL=OFF ^
    -DCMAKE_CONFIGURATION_TYPES:STRING=Debug;Release; ^
    -DCMAKE_CXX_FLAGS_RELEASE='/MD' ^
    -DCMAKE_CXX_FLAGS_DEBUG='/MDd' ^
    -DCMAKE_C_FLAGS_RELEASE='/MD' ^
    -DCMAKE_C_FLAGS_DEBUG='/MDd' ^
    -DZLIB_LIBRARY=%ZLIBDIR%/lib_release/zlibstatic.lib ^
    -DZLIB_INCLUDE_DIR=%ZLIBDIR%/include ^
    -DFLTK_BASE_LIBRARY_RELEASE=%FLTKDIR%/lib_release/fltk.lib ^
    -DFLTK_GL_LIBRARY_RELEASE=%FLTKDIR%/lib_release/fltk_gl.lib ^
    -DFLTK_FORMS_LIBRARY_RELEASE=%FLTKDIR%/lib_release/fltk_forms.lib ^
    -DFLTK_IMAGES_LIBRARY_RELEASE=%FLTKDIR%/lib_release/fltk_images.lib ^
    -DFLTK_BASE_LIBRARY_DEBUG=%FLTKDIR%/lib_debug/fltkd.lib ^
    -DFLTK_GL_LIBRARY_DEBUG=%FLTKDIR%/lib_debug/fltk_gld.lib ^
    -DFLTK_FORMS_LIBRARY_DEBUG=%FLTKDIR%/lib_debug/fltk_formsd.lib ^
    -DFLTK_IMAGES_LIBRARY_DEBUG=%FLTKDIR%/lib_debug/fltk_imagesd.lib ^
    -DFLTK_INCLUDE_DIR=%FLTKDIR%/include ^
    -DCMAKE_INSTALL_PREFIX=%BINDIR% ^
    -DCMAKE_BUILD_TYPE='Release' %SRC%
    ECHO READY
  displayName: execute windows environment build operation
- task: MSBuild@1
  inputs:
    solution: '**/*.sln'
    msbuildArguments: /v:m /m /p:BuildInParallel=true /p:Configuration=Release /p:RunCodeAnalysis=true
